--source include/have_debug_sync.inc
--source include/have_log_bin.inc
--source include/have_perfschema.inc

--echo #
--echo # Bug 92108: Deadlock by concurrent SHOW BINLOGS,
--echo # performance_schema.session_variables query, and binlog purge
--echo #

--source include/count_sessions.inc

FLUSH LOGS;

--connect(con1,localhost,root,,)
--echo # connection con1

SET DEBUG_SYNC="purge_logs_after_lock_index_before_thread_count SIGNAL purge_ready WAIT_FOR finish_purge";

--send PURGE BINARY LOGS BEFORE '2038-01-19'

--connect(con2,localhost,root,,)
--echo # connection con2

SET DEBUG_SYNC="materialize_session_variable_array_THD_locked SIGNAL pfs_ready WAIT_FOR finish_pfs";

--send SELECT * FROM performance_schema.session_variables WHERE VARIABLE_NAME LIKE 'binlog_transaction_dependency_tracking'

--connect(con3,localhost,root,,)
--echo # connection con3

SET DEBUG_SYNC="show_binlogs_after_lock_log_before_lock_index SIGNAL show_ready WAIT_FOR finish_show";

--send SHOW BINARY LOGS

--connection default
--echo # connection default

SET DEBUG_SYNC="now WAIT_FOR purge_ready";
SET DEBUG_SYNC="now WAIT_FOR pfs_ready";
SET DEBUG_SYNC="now WAIT_FOR show_ready";

SET DEBUG_SYNC="now SIGNAL finish_purge";
SET DEBUG_SYNC="now SIGNAL finish_pfs";
SET DEBUG_SYNC="now SIGNAL finish_show";

--connection con1
--echo # connection con1
--reap
--disconnect con1

--connection con2
--echo # connection con2
--reap
--disconnect con2

--connection con3
--echo # connection con3
--disable_result_log
--reap
--enable_result_log
--disconnect con3

--connection default
--echo # connection default

--source include/wait_until_count_sessions.inc
